<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absen Siswa</title>
  <link rel="stylesheet" href="siswa.css">
</head>
<body>

<!-- CEK ROLE -->
<script>
  if(localStorage.getItem("role") !== "siswa"){
    window.location.href = "index.html";
  }
</script>

<h2>Form Absen Siswa</h2>

<!-- JAM -->
<div class="clock-box">
  <div id="clock"></div>
  <div id="date"></div>
</div>

<!-- FORM ABSEN -->
<form id="absenForm">
  <input type="text" id="nama" placeholder="Nama Siswa" required>

  <select id="kelas" required>
    <option value="">Pilih Kelas</option>
    <option>X TKJ 1</option>
    <option>X TKJ 2</option>
    <option>X TKJ 3</option>
  </select>

  <select id="status" required>
    <option value="Hadir">Hadir</option>
    <option value="Izin">Izin</option>
    <option value="Sakit">Sakit</option>
    <option value="Alfa">Alfa</option>
  </select>

  <button id="absenBtn" type="submit">ABSEN SEKARANG</button>
</form>

<p id="absenStatus"></p>

<script>
/* =====================
   SETTING JAM (DARI ADMIN)
===================== */
let settingAbsen = JSON.parse(localStorage.getItem("settingAbsen")) || {
  open: 21,
  close: 22
};

const openHour  = settingAbsen.open;
const closeHour = settingAbsen.close;

/* =====================
   JAM REALTIME
===================== */
function updateClock(){
  const now = new Date();

  document.getElementById("clock").innerText =
    now.toLocaleTimeString();

  document.getElementById("date").innerText =
    now.toLocaleDateString("id-ID", {
      weekday:"long",
      year:"numeric",
      month:"long",
      day:"numeric"
    });

  checkAbsenTime(now.getHours());
}

function checkAbsenTime(hour){
  const btn = document.getElementById("absenBtn");
  const info = document.getElementById("absenStatus");

  if(hour >= openHour && hour < closeHour){
    btn.disabled = false;
    info.innerText = "⏰ Waktu absen dibuka";
    info.style.color = "green";
  }else{
    btn.disabled = true;
    info.innerText =
      `❌ Absen ditutup (${openHour}:00 - ${closeHour}:00)`;
    info.style.color = "red";
  }
}

/* =====================
   SIMPAN ABSEN
===================== */
document.getElementById("absenForm").addEventListener("submit", function(e){
  e.preventDefault();

  const currentHour = new Date().getHours();
  if(currentHour < openHour || currentHour >= closeHour){
    document.getElementById("absenStatus").innerText =
      "❌ Absen di luar jam";
    return;
  }

  const nama   = document.getElementById("nama").value;
  const kelas  = document.getElementById("kelas").value;
  const status = document.getElementById("status").value;

  const now = new Date();
  const today = now.toLocaleDateString();

  let data = JSON.parse(localStorage.getItem("absen")) || [];

  // CEGAH ABSEN DOBEL
  if(data.find(a => a.nama === nama && a.tanggal === today)){
    document.getElementById("absenStatus").innerText =
      "⚠️ Kamu sudah absen hari ini";
    return;
  }

  data.push({
    nama: nama,
    kelas: kelas,
    status: status,
    waktu: now.toLocaleTimeString(),
    tanggal: today
  });

  localStorage.setItem("absen", JSON.stringify(data));

  document.getElementById("absenStatus").innerText =
    "✅ Absen berhasil (" + status + ")";
  this.reset();
});

/* =====================
   JALANKAN JAM
===================== */
setInterval(updateClock, 1000);
updateClock();
</script>

</body>
</html>
